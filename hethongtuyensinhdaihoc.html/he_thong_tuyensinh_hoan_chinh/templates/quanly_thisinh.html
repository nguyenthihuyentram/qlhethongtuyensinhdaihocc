<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω Th√≠ sinh</title>
    <style>
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .card { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .btn { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background: #f8f9fa; }
        .form-group { margin: 10px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 5% auto; padding: 20px; width: 90%; max-width: 600px; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h2>üë• Qu·∫£n l√Ω Th√≠ sinh</h2>
            <button class="btn btn-primary" onclick="openModal()">‚ûï Th√™m th√≠ sinh</button>
            <input type="text" id="searchInput" placeholder="üîç T√¨m ki·∫øm theo t√™n, CMND, m√£ th√≠ sinh..." style="padding: 8px; width: 300px; margin-left: 20px;">
            <button class="btn" onclick="searchThisinh()">T√¨m ki·∫øm</button>
        </div>

        <div class="card">
            <div id="danhSachThisinh"></div>
        </div>
    </div>

    <!-- Modal th√™m/s·ª≠a th√≠ sinh -->
    <div id="modalThisinh" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle">Th√™m th√≠ sinh m·ªõi</h3>
            <form id="formThisinh">
                <input type="hidden" id="thisinhId">
                <div class="form-group">
                    <label>H·ªç v√† t√™n *</label>
                    <input type="text" id="hoTen" required>
                </div>
                <div class="form-group">
                    <label>CMND/CCCD *</label>
                    <input type="text" id="cmnd" required>
                </div>
                <div class="form-group">
                    <label>Ng√†y sinh *</label>
                    <input type="date" id="ngaySinh" required>
                </div>
                <div class="form-group">
                    <label>Gi·ªõi t√≠nh</label>
                    <select id="gioiTinh">
                        <option value="Nam">Nam</option>
                        <option value="N·ªØ">N·ªØ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ƒê·ªãa ch·ªâ</label>
                    <input type="text" id="diaChi">
                </div>
                <div class="form-group">
                    <label>S·ªë ƒëi·ªán tho·∫°i</label>
                    <input type="tel" id="sdt">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="email">
                </div>
                <div class="form-group">
                    <label>Tr·∫°ng th√°i</label>
                    <select id="trangThai">
                        <option value="Ch·ªù duy·ªát">Ch·ªù duy·ªát</option>
                        <option value="ƒê√£ duy·ªát">ƒê√£ duy·ªát</option>
                        <option value="T·ª´ ch·ªëi">T·ª´ ch·ªëi</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-success">üíæ L∆∞u th√¥ng tin</button>
                <button type="button" class="btn" onclick="closeModal()">‚ùå H·ªßy</button>
            </form>
        </div>
    </div>

    <script>
        let currentEditId = null;

        function loadDanhSach() {
            fetch('/api/thisinh')
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        let html = `<table>
                            <thead><tr><th>M√£ TS</th><th>H·ªç t√™n</th><th>CMND</th><th>Ng√†y sinh</th><th>Tr·∫°ng th√°i</th><th>Thao t√°c</th></tr></thead>
                            <tbody>`;
                        
                        data.data.forEach(ts => {
                            let badgeColor = ts.trang_thai === 'ƒê√£ duy·ªát' ? 'green' : 
                                           ts.trang_thai === 'T·ª´ ch·ªëi' ? 'red' : 'orange';
                            html += `
                                <tr>
                                    <td>${ts.ma_thisinh}</td>
                                    <td>${ts.ho_ten}</td>
                                    <td>${ts.cmnd}</td>
                                    <td>${ts.ngay_sinh}</td>
                                    <td><span style="color: ${badgeColor}; font-weight: bold;">${ts.trang_thai}</span></td>
                                    <td>
                                        <button class="btn btn-primary" onclick="editThisinh(${ts.id})">‚úèÔ∏è S·ª≠a</button>
                                        <button class="btn btn-danger" onclick="deleteThisinh(${ts.id})">üóëÔ∏è X√≥a</button>
                                    </td>
                                </tr>
                            `;
                        });
                        
                        html += '</tbody></table>';
                        document.getElementById('danhSachThisinh').innerHTML = html;
                    }
                });
        }

        function openModal(editId = null) {
            currentEditId = editId;
            const modal = document.getElementById('modalThisinh');
            const title = document.getElementById('modalTitle');
            
            if (editId) {
                title.textContent = 'S·ª≠a th√¥ng tin th√≠ sinh';
                // Load data for editing
                fetch('/api/thisinh')
                    .then(r => r.json())
                    .then(data => {
                        const ts = data.data.find(t => t.id === editId);
                        if (ts) {
                            document.getElementById('thisinhId').value = ts.id;
                            document.getElementById('hoTen').value = ts.ho_ten;
                            document.getElementById('cmnd').value = ts.cmnd;
                            document.getElementById('ngaySinh').value = ts.ngay_sinh;
                            document.getElementById('gioiTinh').value = ts.gioi_tinh;
                            document.getElementById('diaChi').value = ts.dia_chi;
                            document.getElementById('sdt').value = ts.sdt;
                            document.getElementById('email').value = ts.email;
                            document.getElementById('trangThai').value = ts.trang_thai;
                        }
                    });
            } else {
                title.textContent = 'Th√™m th√≠ sinh m·ªõi';
                document.getElementById('formThisinh').reset();
            }
            modal.style.display = 'block';
        }

        function closeModal() {
            document.getElementById('modalThisinh').style.display = 'none';
            currentEditId = null;
        }

        function searchThisinh() {
            const search = document.getElementById('searchInput').value;
            fetch('/api/thisinh?search=' + encodeURIComponent(search))
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        let html = `<table><thead><tr><th>M√£ TS</th><th>H·ªç t√™n</th><th>CMND</th><th>Ng√†y sinh</th><th>Tr·∫°ng th√°i</th><th>Thao t√°c</th></tr></thead><tbody>`;
                        data.data.forEach(ts => {
                            let badgeColor = ts.trang_thai === 'ƒê√£ duy·ªát' ? 'green' : 
                                           ts.trang_thai === 'T·ª´ ch·ªëi' ? 'red' : 'orange';
                            html += `
                                <tr>
                                    <td>${ts.ma_thisinh}</td>
                                    <td>${ts.ho_ten}</td>
                                    <td>${ts.cmnd}</td>
                                    <td>${ts.ngay_sinh}</td>
                                    <td><span style="color: ${badgeColor}; font-weight: bold;">${ts.trang_thai}</span></td>
                                    <td>
                                        <button class="btn btn-primary" onclick="editThisinh(${ts.id})">‚úèÔ∏è S·ª≠a</button>
                                        <button class="btn btn-danger" onclick="deleteThisinh(${ts.id})">üóëÔ∏è X√≥a</button>
                                    </td>
                                </tr>
                            `;
                        });
                        html += '</tbody></table>';
                        document.getElementById('danhSachThisinh').innerHTML = html;
                    }
                });
        }

        document.getElementById('formThisinh').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                ho_ten: document.getElementById('hoTen').value,
                cmnd: document.getElementById('cmnd').value,
                ngay_sinh: document.getElementById('ngaySinh').value,
                gioi_tinh: document.getElementById('gioiTinh').value,
                dia_chi: document.getElementById('diaChi').value,
                sdt: document.getElementById('sdt').value,
                email: document.getElementById('email').value,
                trang_thai: document.getElementById('trangThai').value
            };

            if (currentEditId) {
                // Update
                fetch('/api/thisinh/' + currentEditId, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                })
                .then(r => r.json())
                .then(data => {
                    alert(data.message);
                    if (data.success) {
                        closeModal();
                        loadDanhSach();
                    }
                });
            } else {
                // Create
                fetch('/api/thisinh', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                })
                .then(r => r.json())
                .then(data => {
                    alert(data.message);
                    if (data.success) {
                        closeModal();
                        loadDanhSach();
                    }
                });
            }
        });

        function editThisinh(id) {
            openModal(id);
        }

        function deleteThisinh(id) {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a th√≠ sinh n√†y?')) {
                fetch('/api/thisinh/' + id, { method: 'DELETE' })
                    .then(r => r.json())
                    .then(data => {
                        alert(data.message);
                        if (data.success) loadDanhSach();
                    });
            }
        }

        // Load danh s√°ch khi trang ƒë∆∞·ª£c t·∫£i
        window.onload = loadDanhSach;
    </script>
</body>
</html>